<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimate Generator</title>
    <!-- PWA metadata and manifest link -->
    <!-- Updated theme color to match brand green -->
    <meta name="theme-color" content="#5f725d">
    <link rel="manifest" href="manifest.json">
    <!-- Apple touch icon for iOS home screen. iOS uses this link instead of the manifest icons 【295040924771026†L70-L74】 -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <style>
        /* Modernized styles for a more polished look */
        :root {
            /*
             * Color palette customized for the client's brand.  The base green
             * colour (#5f725d) is used for both primary and accent elements.  A
             * darker shade (#4c5b4a) is derived by darkening the base, while a
             * lighter shade (#7b9279) is created by lightening the base.  These
             * variables can be adjusted to fine‑tune the look and feel.
             */
            --primary-color: #5f725d;
            --primary-dark: #4c5b4a;
            --accent-color: #7b9279;
            --accent-dark: #4c5b4a;
            --danger-color: #d9534f;
            --danger-dark: #c9302c;
            --bg-color: #f4f6fa;
            --card-bg: #ffffff;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --text-color: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 2rem;
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.5;
        }

        h1, h2, h3 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        form {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input[type="text"], input[type="number"], input[type="date"], textarea {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #cfd8e3;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            font-family: inherit;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
        }

        textarea {
            resize: vertical;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 1.5rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
        }

        th {
            /* Use a very light green for table header backgrounds */
            background-color: #dee3dd;
            color: var(--primary-dark);
            font-weight: 600;
            /* subtle border in a complementary green */
            border-bottom: 2px solid #c1cfc0;
        }

        tr:nth-child(even) td {
            /* alternate row colour: soft off‑white with a hint of green */
            background-color: #f0f3ef;
        }

        td {
            border-bottom: 1px solid #d9e0dc;
        }

        .actions {
            text-align: right;
            margin-top: 2rem;
        }

        button {
            padding: 0.6rem 1.2rem;
            margin-right: 0.5rem;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        .remove-btn {
            background-color: var(--danger-color);
        }

        .remove-btn:hover {
            background-color: var(--danger-dark);
        }

        /* Totals section */
        .totals {
            max-width: 320px;
            float: right;
            margin-top: 2rem;
            background: #f9fbfe;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        /* Style read-only summary and bullet textareas */
        textarea[readonly] {
            background-color: #f9fbfe;
            border-color: #e0e7f1;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Modal overlay for yes/no prompts */
        #yesNoModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #yesNoModal .modal-content {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 320px;
            width: 90%;
            color: var(--text-color);
            text-align: center;
        }
        #yesNoModal .modal-buttons {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-around;
        }
        #yesNoModal button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            cursor: pointer;
        }
        #yesNoModal button.yes-btn {
            background-color: var(--primary-color);
            color: #fff;
        }
        #yesNoModal button.yes-btn:hover {
            background-color: var(--primary-dark);
        }
        #yesNoModal button.no-btn {
            background-color: var(--danger-color);
            color: #fff;
        }
        #yesNoModal button.no-btn:hover {
            background-color: var(--danger-dark);
        }

        /* Fireworks overlay styles */
        #fireworks-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
            z-index: 3000;
        }
        #fireworks-overlay .firework-piece {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: firework-piece 1s ease-out forwards;
        }
        @keyframes firework-piece {
            from { opacity: 1; transform: translate(0, 0); }
            to { opacity: 0; transform: translate(var(--dx), var(--dy)); }
        }
        #congrats-message {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .totals div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
            font-size: 0.9rem;
        }

        .print-button {
            background-color: var(--accent-color);
        }

        .print-button:hover {
            background-color: var(--accent-dark);
        }

        @media print {
            body {
                background: #fff;
            }
            form {
                box-shadow: none;
                border: none;
                padding: 0;
            }
            button {
                display: none;
            }
        }
    </style>
</head>
<body>
    <h1>Estimate Generator</h1>
    <form id="estimate-form" onsubmit="return false;">
        <div class="form-group">
            <label for="client-name">Client Name</label>
            <input type="text" id="client-name" placeholder="Enter client or customer name"/>
        </div>
        <div class="form-group">
            <label for="estimate-date">Estimate Date</label>
            <input type="date" id="estimate-date" />
        </div>
        <div class="form-group">
            <label for="estimate-number">Estimate Number</label>
            <input type="text" id="estimate-number" placeholder="e.g. EST-1001" />
        </div>
        <div class="form-group">
            <label for="valid-until">Valid Until</label>
            <input type="date" id="valid-until" />
        </div>

        <!-- AI-powered description entry -->
        <h2>Work Description</h2>
        <div class="form-group">
            <label for="work-description">Describe the work to be done</label>
            <textarea id="work-description" rows="4" placeholder="e.g. Paint 1000 sqft of walls with two coats, install new door"></textarea>
        </div>
        <button type="button" id="generate-btn" style="margin-bottom:1rem;">Generate Estimate from Description</button>

        <h2>Line Items</h2>
        <table id="items-table">
            <thead>
                <tr>
                    <th style="width:40%">Description</th>
                    <th style="width:15%">Quantity</th>
                    <th style="width:20%">Rate ($)</th>
                    <th style="width:20%">Amount ($)</th>
                    <th style="width:5%">Delete</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be inserted dynamically -->
            </tbody>
        </table>
        <button type="button" id="add-item-btn">Add Item</button>
        <div class="form-group totals">
            <div>
                <span>Subtotal:</span>
                <span id="subtotal">0.00</span>
            </div>
            <div>
                <label for="tax-rate">Tax Rate (%):</label>
                <input type="number" id="tax-rate" value="0" min="0" step="0.01" style="width:60px;"/>
            </div>
            <div>
                <span>Tax Amount:</span>
                <span id="tax-amount">0.00</span>
            </div>
            <div>
                <label for="markup-rate">Markup (%):</label>
                <!-- Default markup rate set to 15% so that all estimates include a 15 percent
                     profit margin by default. Users can still adjust this if needed. -->
                <input type="number" id="markup-rate" value="15" min="0" step="0.01" style="width:60px;" />
            </div>
            <div>
                <span>Markup Amount:</span>
                <span id="markup-amount">0.00</span>
            </div>
            <div>
                <strong>Total:</strong>
                <strong id="total">0.00</strong>
            </div>
        </div>
        <div class="form-group" style="clear: both;">
            <label for="notes">Notes</label>
            <textarea id="notes" rows="4" placeholder="Additional notes or terms"></textarea>
        </div>

    <!-- Generated estimate summary (read-only) -->
    <div class="form-group" style="clear: both;">
        <label for="estimate-summary">Estimate Summary</label>
        <textarea id="estimate-summary" rows="6" readonly style="background:#f9f9f9;"></textarea>
    </div>

    <!-- Bullet point estimate for client copy (read-only) -->
    <div class="form-group" style="clear: both;">
        <label for="bullet-summary">Bullet Point Estimate</label>
        <textarea id="bullet-summary" rows="8" readonly style="background:#f9f9f9;"></textarea>
    </div>
        <div class="actions">
            <button type="button" class="print-button" id="print-btn">Print / Save as PDF</button>
        </div>

        <!-- System Settings Section -->
        <h2 style="margin-top:2rem;">System Settings</h2>
        <button type="button" id="toggle-settings" style="margin-bottom:1rem;">Show/Hide Settings</button>
        <div id="settings-section" style="display:none; border: 1px solid #ccc; padding: 1rem; border-radius: 4px; background:#f7f7f7;">
            <!-- Labor Cost Setting -->
            <h3>Labor Cost</h3>
            <div class="form-group">
                <label for="labor-cost">Labor Cost per hour ($)</label>
                <input type="number" id="labor-cost" value="50" min="0" step="0.01" style="width:100px;"/>
            </div>

            <!-- Task Cost Mapping -->
            <h3>Task Cost Mapping</h3>
            <p>Define keywords and cost per unit. When the keyword appears in the description, the cost will be applied. Use the unit to describe what the cost refers to (e.g., sqft, hour, item).</p>
            <table id="task-cost-table">
                <thead>
                    <tr>
                        <th style="width:25%">Keyword</th>
                        <th style="width:15%">Min Cost per Unit ($)</th>
                        <th style="width:15%">Max Cost per Unit ($)</th>
                        <th style="width:35%">Unit description</th>
                        <th style="width:10%">Delete</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Task cost rows will appear here -->
                </tbody>
            </table>
            <button type="button" id="add-task-btn">Add Task</button>

            <!-- Material Cost Mapping -->
            <h3 style="margin-top:1.5rem;">Material Cost List</h3>
            <p>Define materials and cost per unit. When the material name appears in the description, the cost will be applied.</p>
            <table id="material-cost-table">
                <thead>
                    <tr>
                        <th style="width:30%">Material Name</th>
                        <th style="width:20%">Cost per Unit ($)</th>
                        <th style="width:40%">Unit description</th>
                        <th style="width:10%">Delete</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Material cost rows will appear here -->
                </tbody>
            </table>
            <button type="button" id="add-material-btn">Add Material</button>
        </div>
    </form>

    <script>
        // Global variable to track caulking ladder height. This is set by a
        // popup in generateFromDescription() whenever caulking is detected.
        let caulkLadderTall = false;
        // Initialize the estimate date to today's date
        document.getElementById('estimate-date').valueAsDate = new Date();
        // Estimate number default: current timestamp truncated
        document.getElementById('estimate-number').value = 'EST-' + Date.now().toString().slice(-6);
        // Valid until default: 30 days from now
        var validDate = new Date();
        validDate.setDate(validDate.getDate() + 30);
        document.getElementById('valid-until').valueAsDate = validDate;

        const tbody = document.querySelector('#items-table tbody');

        // Flags indicating whether certain tasks are on a steep roof. These are
        // reset each time an estimate is generated and may be set via a
        // confirmation dialog when roof vents, ridge guard, or soffit returns
        // are detected in the description.  When true, the respective
        // services use the higher rate (if applicable) and a steep‑roof safety
        // line item is added.  Separate flags allow independent pricing
        // decisions for vents and ridge/ridge guard tasks.
        var isVentSteep = false;
        var isRidgeSteep = false;
        var isSoffitSteep = false;

        function addRow(description = '', quantity = 1, rate = 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="description" value="${description}" placeholder="Item description"/></td>
                <td><input type="number" class="qty" value="${quantity}" min="0" step="0.01"/></td>
                <td><input type="number" class="rate" value="${rate}" min="0" step="0.01"/></td>
                <td>$<span class="amount">0.00</span></td>
                <td><button type="button" class="remove-btn">×</button></td>
            `;
            tbody.appendChild(tr);
            attachRowEvents(tr);
            updateAmounts();
        }

        function attachRowEvents(row) {
            // When quantity or rate changes, update amounts
            const qtyInput = row.querySelector('.qty');
            const rateInput = row.querySelector('.rate');
            qtyInput.addEventListener('input', updateAmounts);
            rateInput.addEventListener('input', updateAmounts);
            // Delete row
            const removeBtn = row.querySelector('.remove-btn');
            removeBtn.addEventListener('click', function() {
                row.remove();
                updateAmounts();
            });
        }

        function updateAmounts() {
            let subtotal = 0;
            const rows = document.querySelectorAll('#items-table tbody tr');
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const rate = parseFloat(row.querySelector('.rate').value) || 0;
                const amount = qty * rate;
                row.querySelector('.amount').textContent = amount.toFixed(2);
                subtotal += amount;
            });
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            const taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
            // Compute markup amount based on markup rate
            const markupRate = parseFloat(document.getElementById('markup-rate').value) || 0;
            const markupAmount = subtotal * (markupRate / 100);
            document.getElementById('markup-amount').textContent = markupAmount.toFixed(2);
            const total = subtotal + taxAmount + markupAmount;
            document.getElementById('total').textContent = total.toFixed(2);

            // If a summary update function exists, refresh the estimate summary
            if (typeof updateSummary === 'function') {
                updateSummary();
            }
        }

        // Event to handle tax rate change
        document.getElementById('tax-rate').addEventListener('input', updateAmounts);
        // Event to handle markup rate change
        document.getElementById('markup-rate').addEventListener('input', updateAmounts);

        // Add first default row for the line items table
        addRow();

        // Add item button for manual line items
        document.getElementById('add-item-btn').addEventListener('click', function() {
            addRow();
        });

        // Print button: play fireworks animation and then open the print dialog (browser print dialog can save as PDF)
        document.getElementById('print-btn').addEventListener('click', function() {
            // Show celebratory fireworks and message
            showFireworks();
            // Delay printing slightly so the animation is visible before the print dialog opens
            setTimeout(function() {
                window.print();
            }, 1700);
        });

        /* ====== System Settings functionality ====== */
        // Toggle the settings section visibility
        const settingsSection = document.getElementById('settings-section');
        document.getElementById('toggle-settings').addEventListener('click', function() {
            if (settingsSection.style.display === 'none' || settingsSection.style.display === '') {
                settingsSection.style.display = 'block';
            } else {
                settingsSection.style.display = 'none';
            }
        });

        // Helper functions to add task and material rows
        function addTaskRow(keyword = '', cost = 0, unit = '') {
            const tBody = document.querySelector('#task-cost-table tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="task-keyword" value="${keyword}" placeholder="e.g. caulking"/></td>
                <td><input type="number" class="task-cost-min" value="${Array.isArray(cost) ? cost[0] : cost}" min="0" step="0.01"/></td>
                <td><input type="number" class="task-cost-max" value="${Array.isArray(cost) ? cost[1] : ''}" min="0" step="0.01"/></td>
                <td><input type="text" class="task-unit" value="${unit}" placeholder="e.g. foot, sqft"/></td>
                <td><button type="button" class="remove-task remove-btn">×</button></td>
            `;
            tBody.appendChild(tr);
            // Delete task row
            tr.querySelector('.remove-task').addEventListener('click', function() {
                tr.remove();
            });
        }
        function addMaterialRow(name = '', cost = 0, unit = '') {
            const tBody = document.querySelector('#material-cost-table tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="material-name" value="${name}" placeholder="e.g. paint"/></td>
                <td><input type="number" class="material-cost" value="${cost}" min="0" step="0.01"/></td>
                <td><input type="text" class="material-unit" value="${unit}" placeholder="e.g. gallon"/></td>
                <td><button type="button" class="remove-material remove-btn">×</button></td>
            `;
            tBody.appendChild(tr);
            tr.querySelector('.remove-material').addEventListener('click', function() {
                tr.remove();
            });
        }

        // Event listeners for adding new task/material entries
        document.getElementById('add-task-btn').addEventListener('click', function() {
            addTaskRow();
        });
        document.getElementById('add-material-btn').addEventListener('click', function() {
            addMaterialRow();
        });

        // Helper functions to collect current task/material mappings
        function getCurrentTaskMapping() {
            const rows = document.querySelectorAll('#task-cost-table tbody tr');
            const mapping = [];
            rows.forEach(row => {
                const keyword = row.querySelector('.task-keyword').value.trim();
                const costMin = parseFloat(row.querySelector('.task-cost-min').value) || 0;
                const costMaxField = row.querySelector('.task-cost-max');
                const costMax = costMaxField && costMaxField.value !== '' ? parseFloat(costMaxField.value) : 0;
                const unit = row.querySelector('.task-unit').value.trim();
                if (keyword) {
                    mapping.push({keyword: keyword, costMin: costMin, costMax: costMax, unit: unit});
                }
            });
            return mapping;
        }
        function getCurrentMaterialMapping() {
            const rows = document.querySelectorAll('#material-cost-table tbody tr');
            const mapping = [];
            rows.forEach(row => {
                const name = row.querySelector('.material-name').value.trim();
                const cost = parseFloat(row.querySelector('.material-cost').value) || 0;
                const unit = row.querySelector('.material-unit').value.trim();
                if (name) {
                    mapping.push({name: name, cost: cost, unit: unit});
                }
            });
            return mapping;
        }

        // Build a human-friendly summary of the current estimate. This summary lists
        // each line item with its quantity, rate, and amount, followed by the subtotal,
        // tax, markup, and total. It populates the read-only textarea with id
        // "estimate-summary".
        function updateSummary() {
            const rows = document.querySelectorAll('#items-table tbody tr');
            let lines = [];
            rows.forEach(row => {
                const desc = row.querySelector('.description').value.trim();
                const qtyVal = row.querySelector('.qty').value;
                const rateVal = row.querySelector('.rate').value;
                const amountVal = row.querySelector('.amount').textContent;
                if (desc) {
                    const qty = qtyVal !== '' ? parseFloat(qtyVal) : 0;
                    const rate = rateVal !== '' ? parseFloat(rateVal) : 0;
                    // Format line item
                    lines.push(`${desc}: ${qty} × $${rate.toFixed(2)} = $${amountVal}`);
                }
            });
            // Append totals
            const subtotal = document.getElementById('subtotal').textContent;
            const taxAmount = document.getElementById('tax-amount').textContent;
            const markupAmount = document.getElementById('markup-amount').textContent;
            const total = document.getElementById('total').textContent;
            lines.push('');
            lines.push(`Subtotal: $${subtotal}`);
            lines.push(`Tax: $${taxAmount}`);
            lines.push(`Markup: $${markupAmount}`);
            lines.push(`Total: $${total}`);
            document.getElementById('estimate-summary').value = lines.join('\n');

            // Also update bullet point summary for client copy
            if (typeof updateBulletSummary === 'function') {
                updateBulletSummary();
            }
        }

        // Build a bullet-point summary of the estimate that is easy to copy/paste for clients.
        // It converts each line item into a descriptive bullet with approximate quantities.
        function updateBulletSummary() {
            const bulletLines = [];
            const rows = document.querySelectorAll('#items-table tbody tr');
            rows.forEach(row => {
                const descRaw = row.querySelector('.description').value.trim();
                const desc = descRaw.toLowerCase();
                const qtyVal = parseFloat(row.querySelector('.qty').value) || 0;
                // Skip material-only lines
                if (desc.includes('(material)')) return;
                // Determine plural suffix
                const plural = qtyVal === 1 ? '' : 's';
                // Define templates for each recognized service
                const templates = {
                    // Use more descriptive, sales-friendly phrasing for each service. Parenthetical
                    // units make it clear when quantities are approximate.
                    'caulking': 'Caulk the gaps in the fascia/soffit where it meets the brick or stone (approx. {qty} ft).',
                    'wildlife prevention covers': 'Install wildlife prevention covers over {qty} attic vent{plural}.',
                    'xl wildlife prevention covers': 'Install {qty} XL wildlife prevention cover{plural}.',
                    'soffit returns': 'Seal {qty} soffit return{plural} on the roof.',
                    'siding corners': 'Seal {qty} siding corner{plural}.',
                    // Simplify siding wrap bullet to remove the parentheses around "siding wrap" and clearly state footage
                    'siding wrap': 'Install metal under the siding (approx. {qty} ft).',
                    'ridge guard': 'Install ridge guard to the ridge cap (approx. {qty} ft).',
                    'bird intimidators': 'Install {qty} bird intimidator{plural}.',
                    'trap set': 'Set {qty} trap{plural} to the attic and basement.',
                    // Follow-ups are phrased as a single action, regardless of quantity
                    'follow ups': 'Follow up to check all the traps and remove any caught rodents.',
                    'attic full remediation': 'Perform attic remediation (approx. {qty} sq ft).',
                    'basement remediation': 'Perform basement remediation (approx. {qty} ft).',
                    'steep roof safety setup': 'Provide safety setup for steep roof.',
                    'paint': 'Paint approximately {qty} square feet.',
                    'garage frame': 'Seal the garage frame with shaped metal.',
                    'pipes and lines': 'Seal the pipes and lines as needed.',
                    // Combine exhaust vent cleaning and cover installation into one descriptive bullet
                    'exhaust vent covers': 'Clean out the exhaust vent and install a wildlife prevention cover over the exhaust vent.',
                    'exhaust vent cleaning': 'Clean out the exhaust vent.',
                    'drip edge corner': 'Seal {qty} drip edge corner{plural}.',
                    'bat cone': 'Install {qty} bat cone{plural} at the bat entry point.',
                    // Additional bullets for new services
                    'animal removed': 'Remove {qty} animal{plural}.',
                    'additional animal': 'Remove {qty} additional animal{plural}.',
                    'one-way door': 'Install one-way door (includes patch).',
                    'outdoor bait stations': 'Install {qty} outdoor bait station{plural}.',
                    'gutter guard': 'Install gutter guard (approx. {qty} ft).',
                    'underground fencing': 'Install underground fencing (approx. {qty} ft).',
                    'inspection only': 'Inspection only (no service chosen).',
                    'camera drop-off': 'Drop off camera.',
                    'camera monitoring': 'Camera monitoring for {qty} day{plural}.',
                    'rehabber drop-off': 'Drop off rehabber.'
                };
                let template = templates[desc] || null;
                if (!template) {
                    // Attempt to map synonyms to base keys
                    // Use lowercased description to map synonyms to base template keys
                    if (desc === 'caulk') template = templates['caulking'];
                    else if (desc === 'wildlife covers' || desc === 'wildlife cover') template = templates['wildlife prevention covers'];
                    else if (desc === 'xl covers' || desc === 'xl cover') template = templates['xl wildlife prevention covers'];
                    else if (desc === 'intimidators' || desc === 'bird intimidator') template = templates['bird intimidators'];
                }
                if (template) {
                    let bullet = template
                        .replace('{qty}', qtyVal)
                        .replace('{plural}', plural);
                    bulletLines.push('• ' + bullet);
                } else if (desc) {
                    // Fallback: generic description
                    bulletLines.push('• ' + descRaw + ' – ' + qtyVal);
                }
            });
            // If both an exhaust vent cleaning bullet and a combined exhaust vent cover bullet
            // are present, remove the cleaning-only bullet.  The combined bullet conveys
            // both actions and avoids duplication.
            const combinedIndex = bulletLines.findIndex(l => l.toLowerCase().includes('install a wildlife prevention cover over the exhaust vent'));
            const cleaningIndex = bulletLines.findIndex(l => l.toLowerCase().startsWith('• clean out the exhaust vent') && !l.toLowerCase().includes('install'));
            if (combinedIndex !== -1 && cleaningIndex !== -1) {
                // Remove the cleaning-only line
                bulletLines.splice(cleaningIndex, 1);
            }
            // Remove duplicate bullet lines that may occur when multiple tasks map to the same description
            const uniqueLines = [];
            bulletLines.forEach(line => {
                if (!uniqueLines.includes(line)) {
                    uniqueLines.push(line);
                }
            });
            document.getElementById('bullet-summary').value = uniqueLines.join('\n');
        }

        // Show a custom Yes/No modal instead of using browser confirm/prompt. Returns a Promise
        // that resolves with true for Yes and false for No. The message parameter is displayed
        // inside the modal. This allows us to prompt the user without relying on native dialogs.
        function showYesNoModal(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('yesNoModal');
                const msgEl = document.getElementById('modal-message');
                const yesBtn = document.getElementById('modal-yes');
                const noBtn = document.getElementById('modal-no');
                // Set the message text
                msgEl.textContent = message;
                // Show modal
                modal.style.display = 'flex';
                // Remove any existing event listeners to avoid multiple triggers
                yesBtn.onclick = null;
                noBtn.onclick = null;
                // Handler for Yes
                yesBtn.onclick = function() {
                    modal.style.display = 'none';
                    resolve(true);
                };
                // Handler for No
                noBtn.onclick = function() {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        }

        // Display fireworks animation and congratulatory message.  This creates an
        // overlay with coloured confetti pieces that animate outward from the
        // centre of the screen and a message in the middle.  After a short
        // duration, the overlay is hidden automatically.
        function showFireworks() {
            const overlay = document.getElementById('fireworks-overlay');
            if (!overlay) return;
            overlay.innerHTML = '';
            // Message
            const msg = document.createElement('div');
            msg.id = 'congrats-message';
            msg.textContent = "Good estimate dude, You're killing it!";
            overlay.appendChild(msg);
            // Generate confetti pieces
            const colours = ['#ff7f50', '#ffd700', '#ff6347', '#adff2f', '#87cefa'];
            for (let i = 0; i < 30; i++) {
                const piece = document.createElement('div');
                piece.className = 'firework-piece';
                piece.style.backgroundColor = colours[Math.floor(Math.random() * colours.length)];
                const dx = (Math.random() * 2 - 1) * 200 + 'px';
                const dy = (Math.random() * 2 - 1) * 200 + 'px';
                piece.style.setProperty('--dx', dx);
                piece.style.setProperty('--dy', dy);
                piece.style.left = '50%';
                piece.style.top = '50%';
                overlay.appendChild(piece);
            }
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 1500);
        }

        // Generate estimate from description using defined mappings
        async function generateFromDescription() {
            const description = (document.getElementById('work-description').value || '').toLowerCase();
            if (!description) return;
            // Reset vent steepness before processing.  If roof vents are
            // mentioned in the description, prompt the user to confirm
            // whether the vents are on a steep roof.  This influences the
            // rate for wildlife prevention covers and adds a safety setup.
            isVentSteep = false;
            // Reset caulking ladder height before processing. If caulking is mentioned,
            // prompt the user to confirm whether the work requires a ladder over 24 ft.
            caulkLadderTall = false;
            const caulkRegex = /\b(caulk|caulking)\b/;
            if (caulkRegex.test(description)) {
                // Use custom Yes/No modal for caulking ladder height
                const userAnswer = await showYesNoModal(
                    'Is the caulking higher than 24 ft?\n\n' +
                    'Selecting Yes applies the higher rate ($12 per ft).\n' +
                    'Selecting No applies the standard rate ($10 per ft).'
                );
                caulkLadderTall = !!userAnswer;
            }
            // Regex to detect any phrasing that refers to roof vents or their synonyms, including XL vent covers.
            // Use a single-line expression to avoid unintended whitespace matching issues.
            const ventRegex = /\b(wildlife\s+prevention\s+covers|wildlife\s+covers?|roof\s+vent\s+covers?|roof\s+vents?|roof\s+vent|vent\s+covers?|vent\s+cover|attic\s+vents?|attic\s+vent|mushroom\s+vents?|mushroom\s+vent|vent\s+guards?|vent\s+guard|mushroom\s+guard|aax\s+xp\s+vent\s+guard|xl\s+wildlife\s+prevention\s+covers?|xl\s+wildlife\s+covers?|xl\s+wildlife\s+cover|xl\s+prevention\s+covers?|xl\s+covers?|xl\s+cover|xl\s+roof\s+vent\s+covers?|xl\s+roof\s+vent\s+cover|xl\s+roof\s+vents?|xl\s+roof\s+vent|xl\s+roof\s+vent\s+guards?|xl\s+roof\s+vent\s+guard)\b/;
            if (ventRegex.test(description)) {
                // Prompt for steepness for roof vents. A yes applies the higher rate and safety setup.
                const steepAnswer = await showYesNoModal(
                    'Are the roof vents on a steep roof?\n\n' +
                    'Selecting Yes applies the higher rate ($150 per cover) and adds safety setup.\n' +
                    'Selecting No applies the standard rate ($125 per cover).'
                );
                isVentSteep = !!steepAnswer;
            }
            // Detect ridge guard or ridge cap to prompt for steepness. The cost for ridge guard uses
            // costMax when the roof is steep.
            const ridgeRegex = /\b(ridge\s*guard|ridge\s*cap)\b/;
            if (ridgeRegex.test(description)) {
                const ridgeAns = await showYesNoModal(
                    'Is the roof steep where ridge guard is being installed?\n\n' +
                    'Selecting Yes applies the higher rate ($22 per ft) and adds safety setup.\n' +
                    'Selecting No applies the standard rate ($18 per ft).'
                );
                isRidgeSteep = !!ridgeAns;
            }
            // Detect soffit returns or soffits to prompt for steepness. Soffit returns are charged a
            // fixed amount per piece but may require safety setup when the roof is steep.
            const soffitRegex = /\b(soffit returns?|soffits)\b/;
            if (soffitRegex.test(description)) {
                const soffitAns = await showYesNoModal(
                    'Are the soffits on a steep roof?\n\n' +
                    'Selecting Yes adds safety setup.\n' +
                    'Selecting No keeps the standard rate.'
                );
                isSoffitSteep = !!soffitAns;
            }
            // Fetch user-defined tasks. If none exist (e.g., settings weren't loaded),
            // fall back to a built-in default list so estimates still generate.
            let tasks = getCurrentTaskMapping();
            if (!tasks || tasks.length === 0) {
                tasks = [
                    // Core services
                    { keyword: 'caulking', costMin: 10, costMax: 12, unit: 'foot' },
                    { keyword: 'ridge guard', costMin: 18, costMax: 22, unit: 'foot' },
                    { keyword: 'siding wrap', costMin: 18, costMax: 22, unit: 'foot' },
                    { keyword: 'siding corners', costMin: 75, costMax: 75, unit: 'each' },
                    { keyword: 'soffit returns', costMin: 200, costMax: 400, unit: 'each' },
                    { keyword: 'wildlife prevention covers', costMin: 125, costMax: 150, unit: 'each' },
                    { keyword: 'xl wildlife prevention covers', costMin: 350, costMax: 450, unit: 'each' },
                    { keyword: 'bird intimidators', costMin: 95, costMax: 95, unit: 'each' },
                    // Trapping and animal removal
                    { keyword: 'trap set', costMin: 249, costMax: 249, unit: 'each' },
                    { keyword: 'animal removed', costMin: 99, costMax: 99, unit: 'each' },
                    { keyword: 'additional animal', costMin: 20, costMax: 20, unit: 'each' },
                    // Follow‑ups and monitoring
                    { keyword: 'follow ups', costMin: 99, costMax: 99, unit: 'each' },
                    // Remediation and painting
                    { keyword: 'attic full remediation', costMin: 7, costMax: 10, unit: 'sqft' },
                    { keyword: 'basement remediation', costMin: 10, costMax: 16, unit: 'foot' },
                    { keyword: 'paint', costMin: 1.5, costMax: 1.5, unit: 'sqft' },
                    // Vent, exhaust and dryer covers/cleaning
                    { keyword: 'exhaust vent covers', costMin: 125, costMax: 125, unit: 'each' },
                    { keyword: 'dryer vent covers', costMin: 125, costMax: 125, unit: 'each' },
                    { keyword: 'exhaust vent cleaning', costMin: 125, costMax: 125, unit: 'each' },
                    // Repairs and exclusions
                    { keyword: 'drip edge corner', costMin: 95, costMax: 95, unit: 'each' },
                    { keyword: 'pipes and lines', costMin: 150, costMax: 150, unit: 'project' },
                    { keyword: 'garage frame', costMin: 125, costMax: 125, unit: 'each' },
                    { keyword: 'gutter guard', costMin: 18, costMax: 22, unit: 'foot' },
                    { keyword: 'underground fencing', costMin: 35, costMax: 70, unit: 'foot' },
                    // Miscellaneous and special services
                    { keyword: 'miscellaneous labor', costMin: 150, costMax: 150, unit: 'hour' },
                    { keyword: 'inspection only', costMin: 150, costMax: 150, unit: 'each' },
                    { keyword: 'camera drop-off', costMin: 99, costMax: 99, unit: 'each' },
                    { keyword: 'camera monitoring', costMin: 20, costMax: 20, unit: 'day' },
                    { keyword: 'rehabber drop-off', costMin: 125, costMax: 125, unit: 'each' },
                    { keyword: 'one-way door', costMin: 449, costMax: 749, unit: 'each' },
                    { keyword: 'outdoor bait stations', costMin: 25, costMax: 25, unit: 'each' },
                    { keyword: 'bat cone', costMin: 250, costMax: 250, unit: 'each' }
                ];
            }
            const materials = getCurrentMaterialMapping();
            const laborCost = parseFloat(document.getElementById('labor-cost').value) || 0;

            // Helper to detect quantity associated with a phrase (keyword or synonym). It
            // prioritizes numbers appearing before the phrase (e.g., "125 ft siding wrap")
            // and falls back to numbers appearing after the phrase (e.g., "paint 1000 sqft").
            // The detection ignores digits separated by any non-digit characters (e.g., units like ft).
            function detectQuantityForPhrase(desc, phrase) {
                const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                // To avoid capturing unrelated numbers (for example, a markup percentage after a
                // phrase), we first look for numbers that appear immediately before the task
                // keyword. If no preceding number is found, we then look for a number that
                // appears after the keyword.  This order helps prevent false matches such as
                // "siding wrap ... mark up 15%" from incorrectly using 15 as the quantity for
                // the siding wrap task.
                // Only consider numbers that are within a reasonable character distance of the
                // phrase to avoid picking up unrelated numbers elsewhere in the description.
                // We search for a number that appears within 30 characters before the phrase. If
                // none is found, we then search for a number within 30 characters after the
                // phrase. This prevents cases like "... 125 wildlife covers. Siding wrap 4 ft"
                // from using 125 as the quantity for siding wrap.
                const beforeRegex = new RegExp('(\\d+(?:\\.\\d+)?)' + '[^\\d]{0,12}' + escaped, 'i');
                const beforeMatch = beforeRegex.exec(desc);
                if (beforeMatch) {
                    return parseFloat(beforeMatch[1]);
                }
                const afterRegex = new RegExp(escaped + '[^\\d]{0,12}(\\d+(?:\\.\\d+)?)', 'i');
                const afterMatch = afterRegex.exec(desc);
                if (afterMatch) {
                    return parseFloat(afterMatch[1]);
                }
                return 1;
            }

            // Helper to detect material quantity by capturing numbers that appear before the material name anywhere in the description.
            // It matches patterns like "5 gallons of paint" or "paint 5 gallons" by looking for the last numeric value preceding the material keyword.
            function detectMaterialQuantity(desc, material) {
                let qty = 1;
                try {
                    // Create a global regular expression to capture numbers that precede the material name.
                    const regex = new RegExp('(\\d+(?:\\.\\d+)?)[^\\d]*' + material, 'g');
                    const matches = desc.matchAll(regex);
                    for (const m of matches) {
                        qty = parseFloat(m[1]);
                    }
                } catch (err) {
                    qty = 1;
                }
                return qty;
            }

            // Helper to detect quantity that appears only before a phrase.  This is used for
            // tasks like trap sets where numbers following the phrase may actually refer to
            // subsequent items (e.g., "trap set with 2 follow ups").  It searches for
            // numbers immediately preceding the given phrase within a small window.  If no
            // preceding number is found, defaults to 1.
            function detectQuantityBeforePhrase(desc, phrase) {
                let qty = 1;
                try {
                    const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp('(\\d+(?:\\.\\d+)?)' + '[^\\d]{0,12}' + escaped, 'i');
                    const match = regex.exec(desc);
                    if (match) {
                        qty = parseFloat(match[1]);
                    }
                } catch (err) {
                    qty = 1;
                }
                return qty;
            }
            // Choose an appropriate cost based on task and description
            function chooseCost(task, desc) {
                let cost = task.costMin;
                if (task.costMax && task.costMax > 0) {
                    const kw = task.keyword.toLowerCase();
                    // Adjust cost based on simple heuristics specific to each task
                    switch (kw) {
                        case 'caulking':
                            // Use user-selected ladder height if available. If caulkLadderTall
                            // is true, apply the higher rate; otherwise apply the lower rate.
                            if (typeof caulkLadderTall !== 'undefined') {
                                cost = caulkLadderTall ? task.costMax : task.costMin;
                            } else {
                                // Determine ladder size if mentioned. A higher rate applies when a ladder of 24 ft or more is specified.
                                // We look for patterns like "24 ft ladder", "30ft ladder", etc. If no ladder size is mentioned, default to the lower rate.
                                const ladderPattern = /(\d+(?:\.\d+)?)\s*(?:ft|foot)\s*(?:ladder|ladders?)/i;
                                const ladderMatch = desc.match(ladderPattern);
                                if (ladderMatch) {
                                    const ladderHeight = parseFloat(ladderMatch[1]);
                                    if (!isNaN(ladderHeight) && ladderHeight >= 24) {
                                        cost = task.costMax;
                                    } else {
                                        cost = task.costMin;
                                    }
                                } else {
                                    // Fallback: If the description explicitly mentions a 24 ft ladder without the word "ladder" afterwards
                                    if (/24\s*ft|24ft|24-foot|24\s*foot/i.test(desc)) {
                                        cost = task.costMax;
                                    } else {
                                        cost = task.costMin;
                                    }
                                }
                            }
                            break;
                        case 'ridge guard':
                            // Use higher rate if the user confirmed ridge guard is on a steep roof.
                            // Otherwise, fall back to the lower rate. If no prompt was used (e.g. older estimates),
                            // consider the word "steep" in the description as a hint for steepness.
                            if (typeof isRidgeSteep !== 'undefined' && isRidgeSteep) {
                                cost = task.costMax;
                            } else if (/steep/.test(desc)) {
                                cost = task.costMax;
                            } else {
                                cost = task.costMin;
                            }
                            break;
                        case 'wildlife prevention covers':
                            // Determine rate for wildlife prevention covers.  If the
                            // user indicated the roof vents are on a steep roof, use
                            // the higher rate.  Otherwise, fall back to size
                            // indicators (large/big) or the base rate.  Note that
                            // "XL" covers are handled separately via a different task.
                            if (typeof isVentSteep !== 'undefined' && isVentSteep) {
                                cost = task.costMax;
                            } else if (/large|big/.test(desc)) {
                                cost = task.costMax;
                            } else {
                                cost = task.costMin;
                            }
                            break;
                        case 'xl wildlife prevention covers':
                            // For XL covers, apply the higher rate when the roof vents are steep. Otherwise use lower rate.
                            if (typeof isVentSteep !== 'undefined' && isVentSteep) {
                                cost = task.costMax;
                            } else {
                                cost = task.costMin;
                            }
                            break;
                        case 'attic full remediation':
                        case 'basement remediation':
                            // Use higher rate if description mentions heavy or severe remediation
                            if (/heavy|severe|extensive/.test(desc)) {
                                cost = task.costMax;
                            } else {
                                cost = task.costMin;
                            }
                            break;
                        default:
                            // Default to average of min and max
                            cost = (task.costMin + task.costMax) / 2;
                            break;
                    }
                }
                return cost;
            }

            // For each task keyword found in the description
            // Define simple synonym mappings for more flexible keyword matching.
            // Keys correspond to task keywords in lower case and values are arrays of alternative phrases
            // that should be treated as equivalent. This helps handle user shorthand like "xl covers"
            // instead of the full keyword "xl wildlife prevention covers".
            // Synonym map for flexible keyword matching. Each key corresponds
            // to a task keyword (lowercase) and maps to alternative phrases that
            // should trigger the same task. Extend this as you add more tasks
            // and phrasing variations. Roof vent covers and vent covers are
            // treated as wildlife prevention covers, etc.
            const synonymsMap = {
                'wildlife prevention covers': [
                    'wildlife covers', 'wildlife cover',
                    // Recognise generic roof vents and roof vent covers as wildlife prevention covers
                    'roof vent covers', 'roof vent cover', 'roof vents', 'roof vent',
                    'vent covers', 'vent cover',
                    // Additional synonyms for roof vents: attic vents, mushroom vents, vent guards
                    'attic vents', 'attic vent', 'mushroom vents', 'mushroom vent',
                    'vent guards', 'vent guard', 'mushroom guard', 'aax xp vent guard'
                ],
                'xl wildlife prevention covers': [
                    'xl covers', 'xl cover', 'xl wildlife covers',
                    'xl wildlife cover', 'xl prevention covers',
                    // Additional synonyms for XL roof vent covers and vents
                    'xl roof vent cover', 'xl roof vent covers', 'xl roof vents', 'xl roof vent',
                    'xl roof vent guard', 'xl roof vent guards',
                    // Short forms like "xl vent" or "xl vents" and variations
                    'xl vent', 'xl vents', 'xl vent cover', 'xl vent covers'
                ],
                'bird intimidators': ['intimidators', 'bird intimidator', 'bird intimidators', 'intimidator', 'bird cones'],
                'caulking': ['caulk'],
                'trap set': ['trap', 'traps', 'trap sets'],
                // Separate tasks for exhaust and dryer vent covers
                'exhaust vent covers': ['exhaust vent cover', 'exhaust vent covers'],
                'dryer vent covers': ['dryer vent cover', 'dryer vent covers'],
                // Exhaust vent cleaning synonyms, including combinations with cover and cleaning phrases
                'exhaust vent cleaning': [
                    'exhaust vent cleaning', 'clean exhaust vent', 'vent cleaning', 'exhaust vent clean',
                    'cleaning exhaust vent', 'cover with cleaning', 'vent cover with cleaning',
                    'exhaust vent cover with cleaning', 'exhaust vent with cleaning'
                ],
                'drip edge corner': ['drip edge corner', 'gutter edge corner'],
                'pipes and lines': ['pipes and lines', 'pipes & lines', 'ac line', 'electrical line', 'gas line'],
                'garage frame': ['garage frame', 'garage opening', 'metal over garage frame'],
                'miscellaneous labor': ['misc', 'miscellaneous', 'hourly', 'labor', 'bird mites', 'nesting removal', 'remove nesting', 'treat'],
                // Bat cone installation synonyms
                'bat cone': ['bat cone', 'bat cones', 'install bat cone', 'install bat cones', 'bat entry point']
                ,
                // Siding wrap synonyms: alternate phrasings for metal installation under siding
                'siding wrap': ['metal under the siding', 'metal behind siding']
                ,
                // Soffit returns synonyms: recognise plural and singular forms and generic "soffits"
                'soffit returns': ['soffit return', 'soffit returns', 'soffits'],
                // Ridge guard synonyms: accept ridge cap phrasing
                'ridge guard': ['ridge guard', 'ridge cap']
                ,
                // Siding corner synonyms
                'siding corners': ['siding corners', 'corner', 'corners'],
                // Animal removal and additional animals
                'animal removed': ['animal removed', 'animals removed', 'animal removal', 'remove animal', 'remove animals'],
                'additional animal': ['additional animal', 'additional animals', 'extra animal', 'extra animals'],
                // One‑way door installation synonyms. Keep phrases specific to avoid matching unrelated words like "door" alone.
                'one-way door': ['one-way door', 'one way door'],
                // Outdoor bait station synonyms. Include variations without "bait" so that phrases
                // like "outdoor stations" are recognised.
                'outdoor bait stations': ['outdoor bait station', 'outdoor bait stations', 'bait station', 'bait stations', 'rodent bait station', 'rodent bait stations', 'outdoor station', 'outdoor stations'],
                // Gutter guard synonyms
                'gutter guard': ['gutter guard', 'gutter guards'],
                // Underground fencing synonyms
                'underground fencing': ['underground fencing', 'underground fence', 'underground fences', 'bury fence', 'buried fence'],
                // Inspection only synonyms
                'inspection only': ['inspection only', 'inspection', 'no service chosen'],
                // Camera drop‑off synonyms
                'camera drop-off': ['camera drop-off', 'camera drop off', 'drop off camera'],
                // Camera monitoring synonyms
                'camera monitoring': ['camera monitoring', 'camera monitor', 'monitoring', 'camera monitor per day'],
                // Rehabber drop‑off synonyms
                'rehabber drop-off': ['rehabber drop-off', 'rehabber drop off', 'drop off rehabber', 'rehabber'],
                // Follow-up visit synonyms
                'follow ups': ['follow ups', 'follow up', 'follow-up', 'return visit', 'check back'],
                // Gutter guard synonyms might also be interpreted as ridge guard if misheard, but we handle separately above
            };

            // Track whether camera monitoring has been handled to avoid duplicate drop‑off rows
            let cameraHandled = false;
            tasks.forEach(task => {
                const keyword = task.keyword.toLowerCase();
                // Determine if the base keyword or any of its synonyms appear in the description.
                const synonyms = synonymsMap[keyword] || [];
                // track which string (keyword or synonym) matched to detect quantity relative to that phrase.
                let matchedPhrase = '';
                if (description.includes(keyword)) {
                    matchedPhrase = keyword;
                } else {
                    for (const syn of synonyms) {
                        if (description.includes(syn)) {
                            matchedPhrase = syn;
                            break;
                        }
                    }
                }
                if (matchedPhrase) {
                    let qty;
                    // Miscellaneous labor: prompt for hours
                    if (keyword === 'miscellaneous labor') {
                        let hoursInput = prompt(
                            'You mentioned work that does not match a predefined service.\n' +
                            'Please enter the number of hours for these miscellaneous tasks:'
                        );
                        qty = parseFloat(hoursInput);
                        if (isNaN(qty) || qty <= 0) {
                            qty = 1;
                        }
                        const rate = chooseCost(task, description);
                        addRow(task.keyword, qty, rate);
                        return;
                    }
                    // Dynamic pricing for soffit returns based on quantity tier.  Charge $400 for
                    // the first soffit and a lower tiered rate for the remaining soffits.  To
                    // simplify invoicing, compute an effective per‑piece rate so that
                    // qty × rate equals 400 + (qty - 1) × tierRate.  Tier rate depends on
                    // total quantity: 2–7 soffits → $300; 8–15 → $250; 16+ → $200.
                    if (keyword === 'soffit returns') {
                        qty = detectQuantityForPhrase(description, matchedPhrase);
                        if (qty <= 0) {
                            qty = 1;
                        }
                        if (qty === 1) {
                            addRow(task.keyword, qty, 400);
                        } else {
                            let tierRate;
                            if (qty < 8) {
                                tierRate = 300;
                            } else if (qty <= 15) {
                                tierRate = 250;
                            } else {
                                tierRate = 200;
                            }
                            const total = 400 + (qty - 1) * tierRate;
                            // Round to two decimals to avoid floating point issues
                            const effectiveRate = Math.round((total / qty) * 100) / 100;
                            addRow(task.keyword, qty, effectiveRate);
                        }
                        return;
                    }
                    // Rehabber drop-off is always a flat charge; ignore quantities in the description
                    if (keyword === 'rehabber drop-off') {
                        // Always quantity 1 regardless of any number specified
                        addRow(task.keyword, 1, task.costMin);
                        return;
                    }
                    // Camera monitoring: add drop-off and per-day charges.  The first day is
                    // treated as the drop-off (camera drop-off) at $99 and subsequent days
                    // are charged at $20 each.  For example, "camera monitoring for 5 days"
                    // results in one Camera drop-off line at $99 and a Camera monitoring
                    // line with quantity 4 at $20 each.  If camera monitoring has already
                    // been handled, skip processing drop-off separately.
                    if (keyword === 'camera monitoring') {
                        qty = detectQuantityForPhrase(description, matchedPhrase);
                        if (!qty || qty < 1) qty = 1;
                        // Add drop-off on first day
                        addRow('Camera drop-off', 1, 99);
                        // Add monitoring days beyond the first
                        if (qty > 1) {
                            addRow(task.keyword, qty - 1, 20);
                        }
                        cameraHandled = true;
                        return;
                    }
                    // Skip separate camera drop-off processing if camera monitoring already handled
                    if (keyword === 'camera drop-off' && cameraHandled) {
                        return;
                    }
                    // Gutter guard: prompt user for price per foot within the allowed range
                    if (keyword === 'gutter guard') {
                        qty = detectQuantityForPhrase(description, matchedPhrase);
                        if (!qty || qty < 1) qty = 1;
                        let priceInput = prompt(
                            'Enter the price per foot for gutter guard between $' + task.costMin + ' and $' + task.costMax + ':',
                            ((task.costMin + task.costMax) / 2).toFixed(2)
                        );
                        let price = parseFloat(priceInput);
                        if (isNaN(price) || price < task.costMin || price > task.costMax) {
                            price = (task.costMin + task.costMax) / 2;
                        }
                        addRow(task.keyword, qty, price);
                        return;
                    }
                    // Underground fencing: prompt user for price per foot within the allowed range
                    if (keyword === 'underground fencing') {
                        qty = detectQuantityForPhrase(description, matchedPhrase);
                        if (!qty || qty < 1) qty = 1;
                        let priceInput = prompt(
                            'Enter the price per foot for underground fencing between $' + task.costMin + ' and $' + task.costMax + ':',
                            ((task.costMin + task.costMax) / 2).toFixed(2)
                        );
                        let price = parseFloat(priceInput);
                        if (isNaN(price) || price < task.costMin || price > task.costMax) {
                            price = (task.costMin + task.costMax) / 2;
                        }
                        addRow(task.keyword, qty, price);
                        return;
                    }
                    // Exhaust vent covers: if the description also includes the word
                    // "clean" or "cleaning" near "exhaust vent", add both cover and
                    // cleaning charges.  This avoids missing the cleaning fee when
                    // phrases like "exhaust vent cover with cleaning" are used.
                    if (keyword === 'exhaust vent covers') {
                        qty = detectQuantityForPhrase(description, matchedPhrase);
                        if (!qty || qty < 1) qty = 1;
                        const rate = chooseCost(task, description);
                        addRow(task.keyword, qty, rate);
                        // If description implies cleaning, also add cleaning line
                        if (/clean|cleaning/.test(description) && /exhaust vent/.test(description)) {
                            // Add cleaning cost using the matching task
                            addRow('Exhaust vent cleaning', qty, 125);
                        }
                        return;
                    }
                    // Dryer vent covers: similar logic for dryer vent cleaning
                    if (keyword === 'dryer vent covers') {
                        qty = detectQuantityForPhrase(description, matchedPhrase);
                        if (!qty || qty < 1) qty = 1;
                        const rate = chooseCost(task, description);
                        addRow(task.keyword, qty, rate);
                        if (/clean|cleaning/.test(description) && /dryer vent/.test(description)) {
                            addRow('Exhaust vent cleaning', qty, 125);
                        }
                        return;
                    }
                    // Trap set: detect quantity only before the phrase so that numbers following
                    // "trap set" (e.g. follow-up counts) are not interpreted as trap set quantity.
                    if (keyword === 'trap set') {
                        qty = detectQuantityBeforePhrase(description, matchedPhrase);
                        const rate = chooseCost(task, description);
                        addRow(task.keyword, qty, rate);
                        return;
                    }
                    // Animal removed: first animal at $99, additional animals at $20 each
                    if (keyword === 'animal removed') {
                        qty = detectQuantityForPhrase(description, matchedPhrase);
                        // Always add the first animal removed
                        addRow(task.keyword, Math.min(qty, 1), 99);
                        if (qty > 1) {
                            // Add additional animals line item
                            addRow('Additional animal', qty - 1, 20);
                        }
                        return;
                    }
                    // For all other tasks, determine quantity and use chooseCost
                    qty = detectQuantityForPhrase(description, matchedPhrase);
                    const rate = chooseCost(task, description);
                    addRow(task.keyword, qty, rate);
                }
            });
            // Materials
            materials.forEach(mat => {
                const nameLower = mat.name.toLowerCase();
                if (description.includes(nameLower)) {
                    // detect material quantity by capturing numbers that appear before the material keyword
                    const quantity = detectMaterialQuantity(description, nameLower);
                    addRow(mat.name + ' (material)', quantity, mat.cost);
                }
            });

            // Fallback: prompt for miscellaneous labor hours when description contains
            // tasks not recognised as any predefined service or synonym.  This is
            // determined by removing all known keywords and synonyms from the
            // description and checking if any alphabetic characters remain.  If
            // so, we ask the user for hours and add a Miscellaneous Labor line.
            (function() {
                let cleaned = description;
                // Build list of all keywords and synonyms from current tasks
                const phrases = [];
                tasks.forEach(t => {
                    const key = t.keyword.toLowerCase();
                    phrases.push(key);
                    const syns = (typeof synonymsMap !== 'undefined' && synonymsMap[key]) || [];
                    syns.forEach(s => phrases.push(s.toLowerCase()));
                });
                phrases.forEach(ph => {
                    const escaped = ph.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp('\\b' + escaped + '\\b', 'g');
                    cleaned = cleaned.replace(regex, '');
                });
                // Remove numbers and non-letter characters
                cleaned = cleaned.replace(/[0-9]+/g, '').replace(/[^a-zA-Z]+/g, '').trim();
                if (cleaned.length > 0) {
                    // Check if a Miscellaneous Labor line already exists
                    let hasMisc = false;
                    const existingRows = document.querySelectorAll('#items-table tbody tr');
                    existingRows.forEach(row => {
                        const descVal = row.querySelector('.description').value.trim().toLowerCase();
                        if (descVal === 'miscellaneous labor') {
                            hasMisc = true;
                        }
                    });
                    if (!hasMisc) {
                        let hoursInput = prompt('Some parts of the description were not recognized as predefined services.\nPlease enter the number of hours for miscellaneous tasks:');
                        let hoursQty = parseFloat(hoursInput);
                        if (isNaN(hoursQty) || hoursQty <= 0) {
                            hoursQty = 1;
                        }
                        addRow('Miscellaneous labor', hoursQty, 150);
                    }
                }
            })();
            // Detect labor hours (e.g. "8 hours", "10 hr")
            const laborRegex = /(\d+(?:\.\d+)?)\s*(hours|hrs|hour|hr)/i;
            const laborMatch = description.match(laborRegex);
            if (laborMatch) {
                const hours = parseFloat(laborMatch[1]);
                if (hours && laborCost) {
                    addRow('Labor', hours, laborCost);
                }
            }

            // If description mentions a steep roof that requires safety equipment,
            // add a fixed-cost line item. We look for "steep" and "roof" in
            // proximity to infer steep roof. The cost is $495 per project.
            const steepRoofRegex = /(steep[^\n]*roof|roof[^\n]*steep)/i;
            // If the description mentions a steep roof OR the user
            // confirmed that roof vents are steep, add the steep roof
            // safety setup.  This ensures safety equipment is charged
            // when required for vents as well as ridges.
            if (steepRoofRegex.test(description) || (typeof isVentSteep !== 'undefined' && isVentSteep)) {
                // Avoid adding duplicate steep-roof lines by checking if one already exists. Add safety setup
                // if the description mentions steep roof or the user confirmed steepness for vents, ridge guard or soffit returns.
                const existingRows = document.querySelectorAll('#items-table tbody tr');
                let hasSteep = false;
                existingRows.forEach(row => {
                    const descVal = row.querySelector('.description').value.trim().toLowerCase();
                    if (descVal === 'steep roof safety setup' || descVal === 'steep roof safety equipment' || descVal === 'steep roof') {
                        hasSteep = true;
                    }
                });
                // Determine whether we need to add safety setup.  Add when description contains a steep roof
                // reference or when any of the specific steep flags are true.
                if (!hasSteep && (steepRoofRegex.test(description) || (typeof isVentSteep !== 'undefined' && isVentSteep) || (typeof isRidgeSteep !== 'undefined' && isRidgeSteep) || (typeof isSoffitSteep !== 'undefined' && isSoffitSteep))) {
                    addRow('Steep roof safety setup', 1, 495);
                }
            }

            // Always default markup to 15%.  If a markup percentage is specified in the
            // description (e.g. "markup 20 percent"), it overrides the default.
            const markupInput = document.getElementById('markup-rate');
            markupInput.value = 15;
            const markupRegex = /(mark\s*up|markup)\s*(\d+(?:\.\d+)?)/i;
            const markupMatch = description.match(markupRegex);
            if (markupMatch) {
                const markupValue = parseFloat(markupMatch[2]);
                if (!isNaN(markupValue)) {
                    markupInput.value = markupValue;
                }
            }
            // Update totals after adding generated rows
            updateAmounts();
        }
        // Attach event to generate button
        document.getElementById('generate-btn').addEventListener('click', generateFromDescription);

        // Provide a couple of example task and material rows by default for illustration
        // Users can adjust or remove these entries as needed
        // Predefined tasks and materials with cost ranges where applicable
        addTaskRow('caulking', [10, 12], 'foot');
        addTaskRow('ridge guard', [18, 22], 'foot');
        addTaskRow('soffit returns', 300, 'each');
        addTaskRow('siding corners', 75, 'each');
        addTaskRow('siding wrap', 18, 'foot');
        addTaskRow('wildlife prevention covers', [125, 150], 'each');
        // Provide range for XL wildlife prevention covers (350-450)
        addTaskRow('xl wildlife prevention covers', [350, 450], 'each');
        addTaskRow('bird intimidators', 95, 'each');
        // Update trap set and follow-ups costs to match pricing chart
        addTaskRow('trap set', 249, 'each');
        addTaskRow('follow ups', 99, 'each');
        addTaskRow('attic full remediation', [7, 10], 'sqft');
        addTaskRow('basement remediation', [10, 16], 'foot');
        addTaskRow('paint', 1.5, 'sqft');
        // Additional tasks requested: exhaust/dryer vent covers, cleaning, drip edge,
        // pipes and lines, garage frame metal, miscellaneous labor, and bat cone installation.
        addTaskRow('exhaust vent covers', 125, 'each');
        addTaskRow('dryer vent covers', 125, 'each');
        addTaskRow('exhaust vent cleaning', 125, 'each');
        addTaskRow('drip edge corner', 95, 'each');
        addTaskRow('pipes and lines', 150, 'project');
        addTaskRow('garage frame', 125, 'each');
        addTaskRow('miscellaneous labor', 150, 'hour');
        addTaskRow('bat cone', 250, 'each');
        // Additional services from pricing chart
        addTaskRow('one-way door', [449, 749], 'each');
        addTaskRow('outdoor bait stations', 25, 'each');
        addTaskRow('gutter guard', [18, 22], 'foot');
        addTaskRow('underground fencing', [35, 70], 'foot');
        addTaskRow('inspection only', 150, 'each');
        addTaskRow('camera drop-off', 99, 'each');
        addTaskRow('camera monitoring', 20, 'day');
        addTaskRow('rehabber drop-off', 125, 'each');
        // Animal removal entries to allow user editing (first and additional animals)
        addTaskRow('animal removed', 99, 'each');
        addTaskRow('additional animal', 20, 'each');
        // materials
        addMaterialRow('paint', 25, 'gallon');

        // Register the service worker for PWA functionality. This enables offline
        // caching and allows the user to install the app on their device.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js').catch(function(err) {
                    console.log('Service worker registration failed: ', err);
                });
            });
        }
    </script>
    <!-- Modal for yes/no prompts -->
    <div id="yesNoModal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button class="yes-btn" id="modal-yes">Yes</button>
                <button class="no-btn" id="modal-no">No</button>
            </div>
        </div>
    </div>

    <!-- Fireworks overlay -->
    <div id="fireworks-overlay"></div>
</body>
</html>